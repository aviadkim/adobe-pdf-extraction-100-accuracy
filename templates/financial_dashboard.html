<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Portfolio Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .card-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
        }
        
        .summary-card {
            text-align: center;
            padding: 1.5rem;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .summary-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .confidence-badge {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        
        .performance-positive {
            color: #28a745;
            font-weight: bold;
        }
        
        .performance-negative {
            color: #dc3545;
            font-weight: bold;
        }
        
        .export-buttons {
            margin-bottom: 1rem;
        }
        
        .btn-export {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 1rem;
        }
        
        .asset-class-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .badge-structured {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .badge-credit {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .badge-hedge {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-chart-line me-3"></i>Financial Portfolio Dashboard</h1>
                    <p class="mb-0">Adobe OCR + Azure Document Intelligence | Messos Portfolio Analysis</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex justify-content-end">
                        <div class="me-3">
                            <div class="summary-value text-white" id="totalValue">Loading...</div>
                            <div class="summary-label text-white-50">Total Portfolio Value</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card summary-card">
                    <div class="summary-value" id="totalSecurities">-</div>
                    <div class="summary-label">Total Securities</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card">
                    <div class="summary-value" id="avgConfidence">-</div>
                    <div class="summary-label">Avg Confidence</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card">
                    <div class="summary-value" id="assetClasses">-</div>
                    <div class="summary-label">Asset Classes</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card">
                    <div class="summary-value" id="currencies">-</div>
                    <div class="summary-label">Currencies</div>
                </div>
            </div>
        </div>

        <!-- Main Data Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-table me-2"></i>Securities Portfolio</h5>
            </div>
            <div class="card-body">
                <!-- Export Buttons -->
                <div class="export-buttons">
                    <button class="btn btn-success btn-export" onclick="exportExcel()">
                        <i class="fas fa-file-excel me-2"></i>Export to Excel
                    </button>
                    <button class="btn btn-primary btn-export" onclick="exportCSV()">
                        <i class="fas fa-file-csv me-2"></i>Export to CSV
                    </button>
                    <button class="btn btn-info btn-export" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Data
                    </button>
                </div>

                <!-- Data Table -->
                <div class="table-responsive">
                    <table id="securitiesTable" class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Security Name</th>
                                <th>ISIN</th>
                                <th>Valorn</th>
                                <th>Quantity</th>
                                <th>Market Value</th>
                                <th>Currency</th>
                                <th>Asset Class</th>
                                <th>Performance YTD</th>
                                <th>Performance Total</th>
                                <th>Confidence</th>
                                <th>Method</th>
                            </tr>
                        </thead>
                        <tbody id="securitiesTableBody">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Asset Class Breakdown -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Asset Class Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <div id="assetClassBreakdown">
                            <!-- Asset class data will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-coins me-2"></i>Currency Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <div id="currencyBreakdown">
                            <!-- Currency data will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-5 py-4 bg-dark text-white text-center">
        <div class="container">
            <p class="mb-0">
                <i class="fas fa-robot me-2"></i>
                Powered by Adobe OCR + Azure Document Intelligence | 
                <span id="lastUpdated">Last Updated: Loading...</span>
            </p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>

    <script>
        let dataTable;
        
        // Load data when page loads
        $(document).ready(function() {
            loadData();
        });
        
        function loadData() {
            fetch('/api/securities')
                .then(response => response.json())
                .then(data => {
                    updateSummary(data.summary);
                    updateTable(data.securities);
                    updateBreakdowns(data.summary);
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    alert('Error loading data. Please refresh the page.');
                });
        }
        
        function updateSummary(summary) {
            document.getElementById('totalSecurities').textContent = summary.total_securities;
            document.getElementById('totalValue').textContent = '$' + summary.total_value.toLocaleString();
            document.getElementById('avgConfidence').textContent = summary.confidence_average.toFixed(1) + '%';
            document.getElementById('assetClasses').textContent = Object.keys(summary.asset_classes).length;
            document.getElementById('currencies').textContent = Object.keys(summary.currencies).length;
            document.getElementById('lastUpdated').textContent = 'Last Updated: ' + summary.extraction_date;
        }
        
        function updateTable(securities) {
            // Destroy existing DataTable if it exists
            if (dataTable) {
                dataTable.destroy();
            }
            
            // Clear table body
            const tbody = document.getElementById('securitiesTableBody');
            tbody.innerHTML = '';
            
            // Add rows
            securities.forEach(security => {
                const row = tbody.insertRow();
                
                // Format performance values
                const performanceYTD = formatPerformance(security.performance_ytd);
                const performanceTotal = formatPerformance(security.performance_total);
                
                // Format asset class badge
                const assetClassBadge = getAssetClassBadge(security.asset_class);
                
                row.innerHTML = `
                    <td title="${security.security_name}">${truncateText(security.security_name, 40)}</td>
                    <td><code>${security.isin}</code></td>
                    <td><code>${security.valorn}</code></td>
                    <td>${security.quantity}</td>
                    <td><strong>${security.market_value}</strong></td>
                    <td><span class="badge bg-secondary">${security.currency}</span></td>
                    <td>${assetClassBadge}</td>
                    <td>${performanceYTD}</td>
                    <td>${performanceTotal}</td>
                    <td><span class="confidence-badge">${security.confidence_score}%</span></td>
                    <td><small>${security.extraction_method}</small></td>
                `;
            });
            
            // Initialize DataTable
            dataTable = $('#securitiesTable').DataTable({
                responsive: true,
                pageLength: 25,
                order: [[4, 'desc']], // Sort by market value descending
                columnDefs: [
                    { targets: [3, 4], className: 'text-end' }, // Right align numbers
                    { targets: [7, 8], className: 'text-center' }, // Center align performance
                    { targets: [9], className: 'text-center' } // Center align confidence
                ]
            });
        }
        
        function updateBreakdowns(summary) {
            // Asset class breakdown
            const assetClassDiv = document.getElementById('assetClassBreakdown');
            assetClassDiv.innerHTML = '';
            
            Object.entries(summary.asset_classes).forEach(([assetClass, data]) => {
                const percentage = ((data.value / summary.total_value) * 100).toFixed(1);
                assetClassDiv.innerHTML += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${assetClass}</span>
                        <div>
                            <span class="badge bg-primary me-2">${data.count}</span>
                            <span class="text-muted">${percentage}%</span>
                        </div>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar" style="width: ${percentage}%"></div>
                    </div>
                `;
            });
            
            // Currency breakdown
            const currencyDiv = document.getElementById('currencyBreakdown');
            currencyDiv.innerHTML = '';
            
            Object.entries(summary.currencies).forEach(([currency, data]) => {
                const percentage = ((data.value / summary.total_value) * 100).toFixed(1);
                currencyDiv.innerHTML += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span><strong>${currency}</strong></span>
                        <div>
                            <span class="badge bg-success me-2">${data.count}</span>
                            <span class="text-muted">${percentage}%</span>
                        </div>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: ${percentage}%"></div>
                    </div>
                `;
            });
        }
        
        function formatPerformance(performance) {
            if (!performance) return '-';
            
            const isPositive = !performance.includes('-');
            const className = isPositive ? 'performance-positive' : 'performance-negative';
            const icon = isPositive ? 'fa-arrow-up' : 'fa-arrow-down';
            
            return `<span class="${className}"><i class="fas ${icon} me-1"></i>${performance}</span>`;
        }
        
        function getAssetClassBadge(assetClass) {
            const badges = {
                'Structured Products': 'badge-structured',
                'Structured Notes': 'badge-structured',
                'Credit Linked Notes': 'badge-credit',
                'Hedge Funds': 'badge-hedge'
            };
            
            const badgeClass = badges[assetClass] || 'badge-structured';
            return `<span class="asset-class-badge ${badgeClass}">${assetClass}</span>`;
        }
        
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        function exportExcel() {
            window.open('/api/export/excel', '_blank');
        }
        
        function exportCSV() {
            window.open('/api/export/csv', '_blank');
        }
        
        function refreshData() {
            loadData();
        }
    </script>
</body>
</html>
